# Токены для доступа к API

Foxtan использует [JWT-токен](https://jwt.io/introduction).

Для совершения запросов необходим `accessToken`. Он используется для авторизации,
и его необходимо включать в запросы.

Foxtan ожидает наличие `accessToken` в одном из мест, таких как:

- заголовок:
    ```
    X-Access-Token: фыркфыркфырк
    ```

- Cookies:
    ```
    Cookie: accessToken=фыркфыркфырк
    ```

`фыркфыркфырк` обозначает Ваш личный токен. Приоритет отдаётся заголовку.

Пример неподписанных и расшифрованных токенов:

```json
// accessToken для неавторизованного клиента
{
  tid: '72797a686572797a6865656b', // 24-символьный hex-идентификатор (token id)
  exp: 1483214400,                 // время, после которого токен перестанет быть валидным
  trustedPostCount: 24,            // количество постов без ввода капчи
  // [default] level: 0,
  // [default] boards: ['*'],
}

// accessToken для авторизованного клиента
{
  tid: '72797a686572797a6865656b', // для примера это 'ryzheryzheek' в hex
  _id: 100,                        // ID пользователя, отсутствует у анонима
  exp: 1483214400,
  trustedPostCount: 24,            // количество постов без ввода капчи
  level: 30,                       // админ-права
  boards: ['d'],                   // ...в разделе /d/
}
```

## Получение токена
Для взаимодействия с Foxtan необходимо получить `accessToken`.

#### HTTP-запрос
`GET /api/v1/token.obtain`

#### URL-параметры
Отсутствуют.

#### Ответ
Foxtan возвращает JSON:
```json
{
  accessToken: <JWT>,
  expires: 1451592000
}
```

Пользователи без JS получают токен при первом запросе к странице движка.
Это достигается с помощью middleware, что перенаправляет на адрес получения токена.
Он сохраняется в cookie, и совершается перенаправление на изначальный адрес запроса.
```
  GET <any API request>  <===>  GET /api/v1/token.obtain
```

## Обновление токена
Токен не вечен, поэтому стоит хотя бы изредка его обновлять.
Для этого Foxtan отправляет параметр expires, который содержит в себе время,
после которого токен будет невалидным.

#### HTTP-запрос
`GET /api/v1/token.renew`

#### URL-параметры
- accessToken

#### Ответ
Foxtan возвращает свежий токен:
```json
{
  accessToken: <JWT>,
  expires: 1451592000
}
```

## Запросы с устаревшим токеном
Если запрос к API совершается с устаревшим токеном, есть два варианта развития событий:
- запрос с заголовком `X-Requested-With`
  
  Клиент наверняка использует JS.
  Возвращается ошибка 403, требуется обновить токен и повторить запрос.

- запрос без заголовка

  В большинстве случаев у пользователя отключен JS.
  Возвращается код 302 и перенаправление на страницу обновления токена.
